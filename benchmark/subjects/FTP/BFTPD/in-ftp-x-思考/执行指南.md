# list.c 分支覆盖执行指南

## 概述

本文档说明了如何使用测试用例来最大化覆盖 `list.c` 文件的分支。

## 关键理解

### 重要限制
- **单个测试文件 = 单个连接**: 每个 `.raw` 文件只代表一个 FTP 连接
- **无法直接控制 list 函数**: `list.c` 的函数是服务器内部用于管理子进程的,无法直接从 FTP 协议层控制
- **需要多次执行**: 要触发多元素列表场景,需要通过多次执行不同的测试用例

### list.c 函数调用时机
1. **bftpd_list_add**: 当有新的 FTP 连接并 fork 子进程时调用
2. **bftpd_list_count**: 在处理 waitpid 回收子进程时调用
3. **bftpd_list_get**: 在查找匹配的子进程时调用
4. **bftpd_list_del**: 在删除已结束的子进程时调用

## 分支覆盖策略

### 策略1: 连接生命周期管理

#### 阶段1: 创建连接序列
为了触发 `bftpd_list_add` 的不同分支:
- **第一个连接** → 触发分支2(空列表添加)
  - 使用: `seed_list_minimal.raw`
  
- **第二个连接** → 触发分支1(列表不为空添加)
  - 使用: `seed_list_single.raw`
  - 在第一个连接建立后快速执行

- **第三个及以上连接** → 触发分支1.1(需要遍历)
  - 使用: `seed_list_long.raw` 或 `seed_list_complex.raw`
  - 在已有连接的基础上继续添加

#### 阶段2: 删除顺序管理

为了触发 `bftpd_list_del` 的不同分支:
- **第一个连接快速退出** → 触发分支1(删除第一个元素)
  - 使用短连接用例,如 `seed_list_minimal.raw`
  
- **中间连接退出** → 触发分支2(删除中间元素)
  - 使用中等长度的连接,在第一个连接退出后再退出

- **末尾连接退出** → 触发分支2(删除末尾元素)
  - 使用长连接用例,最后退出

### 策略2: 连接时长控制

#### 短连接
- **用例**: `seed_list_minimal.raw`, `seed_list_single.raw`
- **目的**: 快速触发添加和删除操作
- **用途**: 第一个连接的快速退出,触发 `bftpd_list_del` 分支1

#### 长连接
- **用例**: `seed_list_long.raw`, `seed_list_complex.raw`
- **目的**: 保持连接时间,允许其他连接建立
- **用途**: 多连接场景,触发 `bftpd_list_add` 分支1.1

### 策略3: 并发执行模拟

虽然单个测试文件只能代表一个连接,但可以通过以下方式模拟多连接场景:

1. **快速连续执行**: 
   ```bash
   # 快速执行多个测试用例
   aflnet-replay seed_list_minimal.raw FTP 2100 1
   aflnet-replay seed_list_single.raw FTP 2100 1
   aflnet-replay seed_list_long.raw FTP 2100 1
   ```

2. **并行执行**: 使用工具同时发送多个连接请求

3. **顺序执行但控制退出时机**: 
   - 先执行长连接用例(保持连接)
   - 再执行短连接用例(快速退出)

## 推荐执行流程

### 流程1: 多连接场景覆盖

```bash
# 1. 启动服务器
./bftpd -D -c basic.conf &

# 2. 快速连续执行多个测试用例
# 第一个连接(最短,快速退出)
timeout 2s aflnet-replay seed_list_minimal.raw FTP 2100 1

# 第二个连接(中等长度)
timeout 3s aflnet-replay seed_list_single.raw FTP 2100 1 &

# 第三个连接(长连接,最后退出)
timeout 5s aflnet-replay seed_list_long.raw FTP 2100 1 &

# 等待所有连接完成
wait
```

### 流程2: 顺序执行模拟

```bash
# 1. 启动服务器
./bftpd -D -c basic.conf &

# 2. 按顺序执行,控制退出时机
# 执行长连接(保持连接)
timeout 10s aflnet-replay seed_list_long.raw FTP 2100 1 &

# 短暂延迟后执行短连接(快速退出)
sleep 1
timeout 2s aflnet-replay seed_list_minimal.raw FTP 2100 1 &

# 再执行一个中等连接
sleep 2
timeout 3s aflnet-replay seed_list_single.raw FTP 2100 1 &

wait
```

### 流程3: 批量执行

```bash
# 创建一个脚本批量执行所有测试用例
for testcase in seed_list_*.raw; do
    echo "Executing $testcase"
    timeout 5s aflnet-replay "$testcase" FTP 2100 1
    sleep 1  # 短暂延迟,确保服务器处理完
done
```

## 覆盖验证

### 使用 gcov 验证覆盖

1. **编译时启用覆盖率**:
   ```bash
   CFLAGS="-fprofile-arcs -ftest-coverage" ./configure
   make
   ```

2. **执行测试用例**:
   按照上述流程执行所有测试用例

3. **生成覆盖率报告**:
   ```bash
   gcov list.c
   cat list.c.gcov
   ```

4. **分析未覆盖的分支**:
   - 查看 `.gcov` 文件中的分支标记
   - 识别 `#####` 标记的未覆盖分支
   - 针对性地创建新的测试用例

## 预期覆盖情况

### 可覆盖的分支
- ✅ `bftpd_list_add` 分支2: 第一个连接
- ✅ `bftpd_list_add` 分支1: 第二个连接
- ✅ `bftpd_list_add` 分支1.1: 第三个连接
- ✅ `bftpd_list_del` 分支1: 第一个连接退出
- ✅ `bftpd_list_del` 分支2: 中间或末尾连接退出
- ✅ `bftpd_list_count` 分支1: 无连接状态
- ✅ `bftpd_list_count` 分支2: 有连接时计算
- ✅ `bftpd_list_get` 分支2: 获取有效索引

### 难以覆盖的分支
- ⚠️ `bftpd_list_del` 分支2.1: 索引超出范围(防御性编程保护)
- ⚠️ `bftpd_list_get` 分支1: 索引超出范围(防御性编程保护)

这些边界条件分支可能是防御性编程的一部分,在实际运行中可能不会触发。

## 优化建议

1. **分析现有用例**: 先运行现有的 seed 文件,查看覆盖情况
2. **识别缺失**: 使用 gcov 找出未覆盖的分支
3. **针对补充**: 根据缺失的分支创建针对性的测试用例
4. **迭代优化**: 持续测试和优化,直到达到满意的覆盖度

## 注意事项

1. **服务器状态**: 确保每次测试前服务器状态是干净的
2. **端口冲突**: 确保测试使用的端口没有被占用
3. **超时设置**: 合理设置超时时间,避免测试用例挂起
4. **并发安全**: 如果并行执行,注意服务器的并发处理能力
