# MAB (Multi-Armed Bandit) 集成说明

## 概述

本文档说明如何在 xpgfuzz 中使用 Multi-Armed Bandit (MAB) 算法来智能选择变异算子。

## 功能说明

MAB 算法使用 UCB1 策略来自动学习哪些变异算子最有效，并根据历史效果动态调整选择概率。这可以显著提高模糊测试的效率。

## 使用方法

### 启用 MAB

使用 `-b` 选项启用 MAB 算法：

```bash
./afl-fuzz -i input_dir -o output_dir -N tcp://127.0.0.1/8554 -P RTSP -b -- ./target_program
```

### 禁用 MAB（默认）

如果不使用 `-b` 选项，xpgfuzz 将使用随机选择变异算子（默认行为）。

## 工作原理

### 1. 变异算子选择

当启用 MAB 后，对于每个约束类型（INTEGER、STRING、ENUM、IP、PATH、HEX），系统会：
- 使用 UCB1 算法选择变异算子
- 记录选择的算子类型
- 等待覆盖率反馈

### 2. 反馈更新

在每次测试用例执行后：
- 如果发现新覆盖率：给予奖励（reward = 1）
- 如果未发现新覆盖率：给予惩罚（reward = 0）

### 3. 自适应学习

MAB 算法会根据反馈自动调整：
- 成功率高的算子会被更频繁地选择
- 成功率低的算子仍有机会被探索（平衡探索与利用）

## 支持的约束类型

| 约束类型 | 变异算子数量 | MAB 支持 |
|---------|------------|---------|
| INTEGER | 25 | ✅ |
| STRING  | 20 | ✅ |
| ENUM    | 8  | ✅ |
| IP      | 15 | ✅ |
| PATH    | 15 | ✅ |
| HEX     | 12 | ✅ |

## 性能影响

- **内存开销**：每个约束类型需要少量内存存储统计信息（约几KB）
- **CPU 开销**：UCB1 算法计算开销很小（O(n)，n为算子数量）
- **学习时间**：通常需要数百到数千次迭代才能看到明显效果

## 最佳实践

1. **长期运行**：MAB 算法需要时间学习，建议运行时间至少数小时
2. **对比测试**：可以对比启用和禁用 MAB 的效果
3. **监控统计**：观察覆盖率提升情况

## 技术细节

### UCB1 算法公式

```
UCB(i) = avg_reward(i) + sqrt(2 * ln(total_pulls) / pulls(i))
```

其中：
- `avg_reward(i)`: 算子 i 的平均奖励
- `total_pulls`: 总选择次数
- `pulls(i)`: 算子 i 被选择的次数

### 代码位置

- MAB 实现：`xpgfuzz/chat-llm.c`
- 反馈更新：`xpgfuzz/afl-fuzz.c` (第4637行附近)
- 配置选项：`xpgfuzz/afl-fuzz.c` (第367行和第10236行)

## 故障排除

### MAB 未生效

1. 确认使用了 `-b` 选项
2. 检查是否有约束字段被识别（查看日志中的 "Header pattern" 和 "Fields pattern"）
3. 确认变异阶段确实使用了约束感知变异

### 性能问题

如果发现性能下降：
1. 检查是否有大量约束字段（可能导致内存占用增加）
2. 考虑禁用 MAB（移除 `-b` 选项）

## 未来改进

- [ ] 添加统计信息输出（显示各算子的成功率）
- [ ] 支持保存/加载 MAB 状态
- [ ] 添加更多 MAB 算法选项（如 Thompson Sampling）

